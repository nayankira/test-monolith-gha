# This workflow is autogenerated by xCLI and should not be manually edited.
name: Test monolith Reusable
on:
  workflow_call:
    inputs:
      env:
        description: env
        required: true
        type: string

jobs:
  get-monolith-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - id: set-matrix
      run: echo "::set-output name=matrix::{\"include\":[{\"app\":\"app-a\"},{\"app\":\"app-b\"}]}"

  app-deploy-matrix:
    needs: get-monolith-matrix
    uses: ./.github/workflows/test-workflows-reusable-deployment.yaml
    strategy:
      matrix: ${{fromJson(needs.get-monolith-matrix.outputs.matrix)}}
    with:
      app: "${{ matrix.app }}"
      env: "${{ inputs.env }}"
      version: "123"
    secrets: inherit
  pre-verify-barrier:
    runs-on: ubuntu-22.04
    needs: [app-deploy-matrix]
    steps:
      - name: "pre verify barrier"
        run: |
          echo "pre verify barrier"
      - name: The job has succeeded
        if: ${{ success() }}
        run: |
          echo "preverify=succeeded" >> $GITHUB_OUTPUT
      - name: The job has failed
        if: ${{ failure() }}
        run: |
          echo "preverify=failed" >> $GITHUB_OUTPUT
  app-a-post:
    if: ${{ always() }}
    needs: [pre-verify-barrier]
    uses: ./.github/workflows/test-workflows-reusable-verification.yaml
    with:
      app: "app-a"
      env: "${{ inputs.env }}"
      version: "123"
    secrets: inherit
  app-b-post:
    if: ${{ always() }}
    needs: [pre-verify-barrier]
    uses: ./.github/workflows/test-workflows-reusable-verification.yaml
    with:
      app: "app-b"
      env: "${{ inputs.env }}"
      version: "123"
    secrets: inherit
  post-verify-barrier:
    runs-on: ubuntu-22.04
    needs: [app-a-post, app-b-post]
    steps:
      - name: "post verify barrier"
        run: |
          echo "post verify barrier"
      - name: The job has succeeded
        if: ${{ success() }}
        run: |
          echo "postverify=succeeded" >> $GITHUB_OUTPUT
      - name: The job has failed
        if: ${{ failure() }}
        run: |
          echo "postverify=failed" >> $GITHUB_OUTPUT
